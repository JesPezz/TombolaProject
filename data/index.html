<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tómbola Admin</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); max-width: 400px; margin: auto; }
        textarea { width: 90%; height: 150px; margin-bottom: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 5px;}
        .nav { display: flex; margin-bottom: 20px; }
        .nav button { background: #ddd; color: black; border-radius: 0; }
        .nav button.active { background: #007bff; color: white; }
        #qrcode { margin: 20px auto; display: flex; justify-content: center; }
        #qrcode img { border: 5px solid white; border-radius: 8px; }
        .ip-link { display: block; margin-top: 10px; color: #007bff; text-decoration: none; font-size: 1.2em;}
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <button id="btnRegistro" class="active" onclick="show('registro')">Registro</button>
            <button id="btnAdmin" onclick="show('admin')">Admin</button>
        </div>

        <div id="registro">
            <h2>Pasar Lista</h2>
            <form action="/registrar" method="GET">
                <input type="text" name="nombre" placeholder="Tu nombre..." required style="width: 85%; padding: 10px; margin-bottom: 10px;">
                <button type="submit">¡Registrarme!</button>
            </form>
        </div>

        <div id="admin" style="display:none;">
            <h2>Carga Masiva</h2>
            <p style="font-size: 12px; color: #666;">Pega aquí la lista de Excel (un nombre por línea)</p>
            <form action="/upload_nombres" method="POST">
                <textarea name="lista" placeholder="Alumno 1&#10;Alumno 2..."></textarea>
                <button type="submit" style="background-color: #28a745;">Guardar Lista Completa</button>
            </form>
            <hr>
            <button onclick="location.href='/reset_lista'" style="background-color: #dc3545;">Borrar Todo</button>
        </div>
    </div>

    <div class="card">
    <h3>Cargar Banco de Preguntas</h3>
    <textarea id="txtPreguntas" rows="10" style="width:100%" placeholder="Una pregunta por linea..."></textarea>
    <br>
    <button onclick="subirPreguntas()">Guardar Preguntas</button>

    <div class="card" style="text-align: center;">
    <h2>¡Regístrate aquí!</h2>
    
    <div id="qrcode"></div>
    
    <p>O entra directamente a:</p>
    <a id="linkTexto" class="ip-link" href="#">Cargando...</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // 1. Obtener la IP actual y armar la URL de registro
    var ip = window.location.hostname;
    // Si estamos probando en PC local sin ESP32, usa localhost
    if (!ip) ip = "localhost"; 
    
    var urlRegistro = "http://" + ip + "/registro_alumno.html"; // Asegúrate que este archivo exista o redirige a /

    // 2. Generar QR Localmente (No requiere Google API)
    try {
        var qrcode = new QRCode(document.getElementById("qrcode"), {
            text: urlRegistro,
            width: 180,
            height: 180,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    } catch (e) {
        console.error("No se pudo cargar librería QR, usando respaldo de Google");
        // Fallback a Google si la librería falla
        document.getElementById("qrcode").innerHTML = 
            `<img src="https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(urlRegistro)}" alt="QR">`;
    }

    // 3. Actualizar el enlace de texto (Plan B infalible)
    var link = document.getElementById("linkTexto");
    link.href = urlRegistro;
    link.innerText = "http://" + ip;
       
    function show(id) {
            document.getElementById('registro').style.display = id === 'registro' ? 'block' : 'none';
            document.getElementById('admin').style.display = id === 'admin' ? 'block' : 'none';
            document.getElementById('btnRegistro').className = id === 'registro' ? 'active' : '';
            document.getElementById('btnAdmin').className = id === 'admin' ? 'active' : '';
        }

        function subirPreguntas() {
    let contenido = document.getElementById("txtPreguntas").value;
    let formData = new FormData();
    formData.append("preguntas", contenido);

    fetch("/upload_preguntas", { method: "POST", body: formData })
    .then(r => r.text()).then(t => alert(t));
}
    </script>
</body>
</html>